<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>第一ミッション</title>
  <link rel="stylesheet" href="css/style.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Reggae+One&display=swap" rel="stylesheet">

  <link href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/0.0.10/font-awesome-animation.css" type="text/css" media="all" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: "Reggae One", system-ui;
      font-weight: 400;
      font-style: normal;
    }
    .container {
      width: 100%;
      max-width: 1000px;
    }
    i{
      padding-right: 18px;
    }
    .form-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    form {
      margin-right: 20px;
      width: 100%;
    }
    #preview {
      max-width: 100%;
      height: auto;
      margin-top: 20px;
    }
    button {
      padding: 0 30px;
      margin: 50px 100px;
    }
    #output {
      margin-top: 20px;
    }
    h1{
      font-size: 48px;
      padding: 40px 0;
    }
    h2{
      text-align: center;
      font-size: 32px;
    }
    h3{
      text-align: center;
    }
    p{
      padding: 40px 0;
    }
    .checklist-content{
      display: flex;
    }
    .item1{
      margin-right: 48px;
    }
    .item2{
      margin-left: 48px;
    }
    #checklist{
      background-color: #FAFAD2;
      padding: 0 30px 30px 30px;
    }
    .check-item{
      font-size: 32px;
    }
    .checklist-content label{
      font-size: 24px;
    }


    .accordion-003 {
    max-width: 500px;
    margin-bottom: 7px;
    border-bottom: 2px solid #d0d0d0;
}

.accordion-003 summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    padding: 1em 2em;
    color: #000000;
    font-weight: 600;
    cursor: pointer;
}

.accordion-003 summary::-webkit-details-marker {
    display: none;
}

.accordion-003 summary::before,
.accordion-003 summary::after {
    width: 3px;
    height: .9em;
    border-radius: 5px;
    background-color: #000000b3;
    content: '';
}

.accordion-003 summary::before {
    position: absolute;
    right: 2em;
    rotate: 90deg;
}

.accordion-003 summary::after {
    transition: rotate .3s;
}

.accordion-003[open] summary::after {
    rotate: 90deg;
}

.accordion-003 p {
    transform: translateY(-10px);
    opacity: 0;
    margin: 0;
    padding: .3em 2em 1.5em;
    color: #050505;
    transition: transform .5s, opacity .5s;
}

.accordion-003[open] p {
    transform: none;
    opacity: 1;
}

.container label{
  padding-top: 40px;
}
  </style>
</head>
<body>
<h1>腐食のロスエッグリーパー（卵）<div class = "star-level"><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i></div></h1>
<img src = "img/賞味期限切れ.png" alt = "poteto">
<p>食品買ったのを忘れてすぐ腐らせてしまう腐食のロスエッグリーパーを発見！<br>誰の意見も聞かない、お調子者。食品を忘れず食べてもらわなきや！<br>この腐食のロスエッグリーパーを倒すためには、秘伝のアイテムを集めて、"黄金の勇者飯（チャーハン） "を作らねばならない！<br>黄金の勇者飯によって、お調子者を正すことができるか！</p>
<div id="checklist">
  <h2>黄金の勇者飯（チャーハン）</h2>
  <div class = "checklist-content">
  <div class = "item1">
  <label><input type="checkbox" class="check-item" data-name="卵" data-quantity="1"> 卵 - 2個</label><br>
  <label><input type="checkbox" class="check-item" data-name="長ネギ" data-quantity="1"> 長ネギ - 1本</label><br>
  </div>
  <div class = "item2">
  <label><input type="checkbox" class="check-item" data-name="ごはん" data-quantity="1"> ごはん - 1合</label><br>
  <label><input type="checkbox" class="check-item" data-name="紅ショウガ" data-quantity="50"> 紅ショウガ - 50グラム</label><br>
  </div>
</div>
<details class="accordion-003">
  <summary><div><i class="fa-solid fa-key"></i>キーアイテム</div></summary>
  <p>サラダ油…大さじ1<br>醤油…小さじ2<br>塩…2つまみほど<br>こしょう…少々</p>
</details>
</div>

<div class="container">
  <h3>秘伝のアイテムボックス</h3>
  <form id="ingredient-form">
    <label for="name">食材の名前:</label>
    <select id="name" name="name" required>
      <option value="" disabled selected>選択してください</option>
      
      <option value="ごはん">ごはん</option>
      <option value="うどん">うどん</option>
      <option value="パスタ">パスタ</option>
      <option value="鶏もも">鶏もも</option>
      <option value="牛肉">牛肉</option>
      <option value="ベーコン">ベーコン</option>
      <option value="卵">卵</option>
      <option value="長ネギ">長ネギ</option>
      <option value="なす">なす</option>
      <option value="トマト">トマト</option>
      <option value="玉ねぎ">玉ねぎ</option>
      <option value="じゃがいも">じゃがいも</option>
      <option value="にんじん">にんじん</option>
      <option value="きゃべつ">きゃべつ</option>
      <option value="アスパラ">アスパラ</option>
      <option value="ごぼう">ごぼう</option>
      <option value="紅ショウガ">紅ショウガ</option>
      <option value="パプリカ">パプリカ</option>
      <option value="ピーマン">ピーマン</option>
      <option value="もやし">もやし</option>
      <option value="にんにく">にんにく</option>
      <option value="里芋">里芋</option>
      <option value="しめじ">しめじ</option>
      <option value="椎茸">椎茸</option>
      <option value="こんにゃく">こんにゃく</option>
      <option value="バター">バター</option>
      <option value="チーズ">チーズ</option>
      
      
      
    </select>

    <label for="quantity">個数（個数/グラム/合/本）:</label>
    <input type="number" id="quantity" name="quantity" step = "0.5" required>

    <label for="photo">写真:</label>
    <input type="file" id="photo" name="photo" accept="image/*" required>

    <button type="submit">登録</button>
  </form>
  <div id="output"></div>

  <button id="mission-button" style="display:none;" onclick="goToSecondMission()">次へ進む</button>
</div>

<script>
let db;
const request = indexedDB.open('IngredientsDB', 1);

request.onupgradeneeded = function(event) {
  db = event.target.result;
  const objectStore = db.createObjectStore('ingredients', { keyPath: 'name' });
};

request.onsuccess = function(event) {
  db = event.target.result;
  displayStoredIngredients();
  loadChecklistState();
  autoCheckIngredients();
  checkMissionButton();
};

request.onerror = function(event) {
  console.error('Database error:', event.target.errorCode);
};

document.getElementById('ingredient-form').addEventListener('submit', function(event) {
  event.preventDefault();

  const name = document.getElementById('name').value;
  const quantity = parseFloat(document.getElementById('quantity').value);
  const photo = document.getElementById('photo').files[0];

  const now = new Date();
  const formattedDate = now.toLocaleString();

  const reader = new FileReader();
  reader.onload = function(e) {
    const ingredient = {
      name: name,
      quantity: quantity,
      date: formattedDate,
      photo: e.target.result
    };

    saveIngredient(ingredient);
    document.getElementById('ingredient-form').reset();
    checkMissionButton();
  };

  reader.readAsDataURL(photo);
});

function saveIngredient(ingredient) {
  const transaction = db.transaction(['ingredients'], 'readwrite');
  const objectStore = transaction.objectStore('ingredients');
  
  const request = objectStore.get(ingredient.name);
  request.onsuccess = function(event) {
    const existingIngredient = event.target.result;
    if (existingIngredient) {
      ingredient.quantity = parseFloat((existingIngredient.quantity + ingredient.quantity).toFixed(1));
    }
    const requestUpdate = objectStore.put(ingredient);
    requestUpdate.onsuccess = function() {
      displayStoredIngredients();
      updateChecklist(ingredient.name);
    };
  };

  request.onerror = function(event) {
    console.error('Error updating ingredient:', event.target.errorCode);
  };
}

function displayStoredIngredients() {
  const transaction = db.transaction(['ingredients'], 'readonly');
  const objectStore = transaction.objectStore('ingredients');
  
  const output = document.getElementById('output');
  output.innerHTML = '';

  objectStore.openCursor().onsuccess = function(event) {
    const cursor = event.target.result;
    if (cursor) {
      addIngredientToOutput(cursor.value);
      cursor.continue();
    }
  };
}

function addIngredientToOutput(ingredient) {
  const outputItem = document.createElement('div');
  outputItem.classList.add('output-item');

  outputItem.innerHTML =
    `<strong>食材の名前:</strong> ${ingredient.name}<br>
     <strong>個数:</strong> ${ingredient.quantity.toFixed(1)}<br>
     <strong>登録した日時:</strong> ${ingredient.date}<br>
     <img src="${ingredient.photo}" alt="写真"><br>
     <button class="delete-button" data-name="${ingredient.name}">削除</button>`;

  document.getElementById('output').appendChild(outputItem);

  outputItem.querySelector('.delete-button').addEventListener('click', function() {
    deleteIngredient(ingredient.name);
  });
}

function deleteIngredient(name) {
  const transaction = db.transaction(['ingredients'], 'readwrite');
  const objectStore = transaction.objectStore('ingredients');
  const request = objectStore.delete(name);

  request.onsuccess = function() {
    displayStoredIngredients();
    const checklistItem = document.querySelector(`.check-item[data-name="${name}"]`);
    if (checklistItem) {
      checklistItem.checked = false;
      localStorage.setItem(name, JSON.stringify(false));
      checkMissionButton();
    }
  };
}

function loadChecklistState() {
  const checklistItems = document.querySelectorAll('.check-item');
  checklistItems.forEach(item => {
    const itemName = item.dataset.name;
    item.checked = JSON.parse(localStorage.getItem(itemName)) || false;
    item.addEventListener('change', function() {
      localStorage.setItem(itemName, JSON.stringify(item.checked));
      checkMissionButton();
    });
  });
}

function checkMissionButton() {
  const allChecked = Array.from(document.querySelectorAll('.check-item')).every(item => item.checked);
  const missionButton = document.getElementById('mission-button');
  missionButton.style.display = allChecked ? 'block' : 'none';
}

function autoCheckIngredients() {
  const transaction = db.transaction(['ingredients'], 'readonly');
  const objectStore = transaction.objectStore('ingredients');
  const checklistItems = document.querySelectorAll('.check-item');

  objectStore.openCursor().onsuccess = function(event) {
    const cursor = event.target.result;
    if (cursor) {
      const ingredient = cursor.value;
      const matchingItem = Array.from(checklistItems).find(item => item.dataset.name === ingredient.name);
      if (matchingItem) {
        const requiredQuantity = parseInt(matchingItem.dataset.quantity, 10);
        matchingItem.checked = ingredient.quantity >= requiredQuantity;
        localStorage.setItem(ingredient.name, JSON.stringify(matchingItem.checked));
      }
      cursor.continue();
    }
  };

  checkMissionButton();
}

function updateChecklist(ingredientName) {
  const transaction = db.transaction(['ingredients'], 'readonly');
  const objectStore = transaction.objectStore('ingredients');
  const checklistItem = document.querySelector(`.check-item[data-name="${ingredientName}"]`);

  if (checklistItem) {
    const request = objectStore.get(ingredientName);
    request.onsuccess = function(event) {
      const ingredient = event.target.result;
      if (ingredient) {
        const requiredQuantity = parseInt(checklistItem.dataset.quantity, 10);
        checklistItem.checked = ingredient.quantity >= requiredQuantity;
        localStorage.setItem(ingredient.name, JSON.stringify(checklistItem.checked));
      }
      checkMissionButton();
    };
  }
}

function goToSecondMission() {
  const allChecked = Array.from(document.querySelectorAll('.check-item')).every(item => item.checked);
  if (allChecked) {
    updateIngredientQuantities();
    window.location.href = 'mission2_1.html';
  } else {
    alert('すべてのチェックボックスがチェックされていません。まだ未完成です。');
  }
}

function updateIngredientQuantities() {
  const transaction = db.transaction(['ingredients'], 'readwrite');
  const objectStore = transaction.objectStore('ingredients');
  const checklistItems = document.querySelectorAll('.check-item');

  checklistItems.forEach(item => {
    if (item.checked) {
      const ingredientName = item.dataset.name;
      const requiredQuantity = parseInt(item.dataset.quantity, 10);
      const request = objectStore.get(ingredientName);

      request.onsuccess = function(event) {
        const ingredient = event.target.result;
        if (ingredient) {
          ingredient.quantity -= requiredQuantity;
          if (ingredient.quantity <= 0) {
            objectStore.delete(ingredientName);
            item.checked = false;
            localStorage.setItem(ingredientName, JSON.stringify(false));
          } else {
            objectStore.put(ingredient);
          }
        }
      };
    }
  });

  transaction.oncomplete = function() {
    checkMissionButton();
    displayStoredIngredients();
  };
}
</script>
</body>
</html>
